{"version":3,"file":"index.js","sources":["../src/WebSocketWrapper.mjs","../src/wrapHandlers.mjs","../src/WebSocketExpress.mjs","../src/Router.mjs","../src/auth.mjs","../src/index.mjs"],"sourcesContent":["import { STATUS_CODES } from 'http';\n\nconst NONCE = {};\n\n// Copied from https://github.com/websockets/ws/blob/master/lib/websocket-server.js#L374\nfunction abortHandshake(socket, code, message, headers) {\n  if (socket.writable) {\n    const resolvedMessage = message || STATUS_CODES[code];\n    const resolvedHeaders = {\n      Connection: 'close',\n      'Content-type': 'text/html',\n      'Content-Length': Buffer.byteLength(resolvedMessage),\n      ...headers,\n    };\n\n    socket.write(\n      [\n        `HTTP/1.1 ${code} ${STATUS_CODES[code]}`,\n        ...Object.keys(resolvedHeaders).map(\n          (h) => `${h}: ${resolvedHeaders[h]}`,\n        ),\n        '',\n        resolvedMessage,\n      ].join('\\r\\n'),\n    );\n  }\n\n  socket.destroy();\n}\n\nfunction httpStatusToWs(code) {\n  if (code >= 500) {\n    return 1011;\n  }\n  return 4000 + code;\n}\n\nfunction nextMessage(ws, { timeout = 0 } = {}) {\n  return new Promise((resolve, reject) => {\n    let onMessage = null;\n    let onClose = null;\n    let exp = null;\n\n    const detach = () => {\n      ws.off('message', onMessage);\n      ws.off('close', onClose);\n      clearTimeout(exp);\n    };\n\n    onMessage = (data, isBinary) => {\n      detach();\n      if (isBinary !== undefined) {\n        // ws 8.x\n        resolve({ data, isBinary });\n      } else if (typeof data === 'string') {\n        // ws 7.x\n        resolve({ data: Buffer.from(data, 'utf8'), isBinary: false });\n      } else {\n        resolve({ data, isBinary: true });\n      }\n    };\n\n    onClose = () => {\n      detach();\n      reject();\n    };\n\n    ws.on('message', onMessage);\n    ws.on('close', onClose);\n    if (timeout > 0) {\n      exp = setTimeout(onClose, timeout);\n    }\n  });\n}\n\nfunction bindExtraMethods(ws) {\n  // eslint-disable-next-line no-param-reassign\n  ws.nextMessage = nextMessage.bind(null, ws);\n}\n\nexport default class WebSocketWrapper {\n  constructor(wsServer, req, socket, head) {\n    this.wsServer = wsServer;\n    this.req = req;\n    this.socket = socket;\n    this.head = head;\n    this.ws = null;\n    this.closed = false;\n    this.nonce = NONCE;\n    this.transactionNesting = 0;\n    this.closeTimeout = null;\n    this.closeTime = 0;\n    this.closeTimeoutCode = null;\n    this.closeTimeoutMessage = null;\n    this.softClosing = false;\n\n    // expressjs builds new objects using properties of response, so all methods\n    // must be explicitly added to the instance, not just the class\n    this.accept = this.accept;\n    this.reject = this.reject;\n    this.closeAtTime = this.closeAtTime;\n    this.sendError = this.sendError;\n    this.setHeader = () => {}; // compatibility with expressjs (fake http.Response API)\n    this.status = this.status;\n    this.end = this.end;\n    this.send = this.send;\n    this.beginTransaction = this.beginTransaction;\n    this.endTransaction = this.endTransaction;\n    this.internalCheckCloseTimeout = this.internalCheckCloseTimeout;\n    this.internalSoftClose = this.internalSoftClose;\n  }\n\n  static isInstance(o) {\n    // expressjs builds new objects using properties of response, so we cannot\n    // rely on instanceof checks. Instead we use a nonce property:\n    return o && o.nonce === NONCE;\n  }\n\n  accept() {\n    if (this.closed) {\n      return Promise.reject(new Error('Connection closed'));\n    }\n    if (this.ws) {\n      return Promise.resolve(this.ws);\n    }\n\n    return new Promise((resolve) =>\n      this.wsServer.handleUpgrade(this.req, this.socket, this.head, (ws) => {\n        bindExtraMethods(ws);\n        ws.on('close', () => clearTimeout(this.closeTimeout));\n        this.ws = ws;\n        resolve(this.ws);\n      }),\n    );\n  }\n\n  reject(code = 500, message = null) {\n    if (this.ws) {\n      throw new Error('Already accepted WebSocket connection');\n    }\n    this.sendError(code, null, message);\n  }\n\n  sendError(httpStatus, wsStatus = null, message = null) {\n    if (this.closed) {\n      throw new Error('Connection closed');\n    }\n\n    const msg = message || STATUS_CODES[httpStatus];\n\n    this.closed = true;\n    if (this.ws) {\n      this.ws.close(wsStatus || httpStatusToWs(httpStatus), msg);\n    } else {\n      abortHandshake(this.socket, httpStatus, msg);\n    }\n  }\n\n  internalCheckCloseTimeout() {\n    clearTimeout(this.closeTimeout);\n\n    if (this.closed) {\n      return;\n    }\n\n    const now = Date.now();\n    if (now < this.closeTime) {\n      this.closeTimeout = setTimeout(\n        this.internalCheckCloseTimeout.bind(this),\n        Math.min(this.closeTime - now, 1000 * 60 * 60 * 24),\n      );\n      return;\n    }\n\n    this.closed = true;\n    if (this.ws) {\n      this.ws.close(this.closeTimeoutCode, this.closeTimeoutMessage);\n    } else {\n      abortHandshake(this.socket, 200, 'Connection time limit reached');\n    }\n  }\n\n  closeAtTime(time, code = 1001, message = '') {\n    if (this.closed) {\n      return;\n    }\n    if (this.closeTimeout !== null && time >= this.closeTime) {\n      return;\n    }\n    this.closeTime = time;\n    this.closeTimeoutCode = code;\n    this.closeTimeoutMessage = message;\n    this.internalCheckCloseTimeout();\n  }\n\n  status(code) {\n    if (code < 400 && this.ws) {\n      throw new Error('Already accepted WebSocket connection');\n    }\n    this.sendError(code);\n    return this;\n  }\n\n  end() {\n    if (!this.ws && !this.closed) {\n      this.sendError(404);\n    }\n    return this;\n  }\n\n  send(message) {\n    if (!this.closed) {\n      this.accept().then((ws) => {\n        ws.send(message);\n        ws.close();\n      });\n      this.closed = true;\n    }\n    return this;\n  }\n\n  beginTransaction() {\n    this.transactionNesting += 1;\n  }\n\n  endTransaction() {\n    if (this.transactionNesting <= 0) {\n      throw new Error('Unbalanced endTransaction');\n    }\n    this.transactionNesting -= 1;\n\n    if (this.transactionNesting === 0 && this.softClosing && !this.closed) {\n      this.sendError(500, 1012, 'server shutdown');\n    }\n  }\n\n  internalSoftClose(limit) {\n    if (this.closed) {\n      return;\n    }\n\n    if (this.transactionNesting > 0) {\n      this.softClosing = true;\n      if (limit) {\n        this.closeAtTime(limit, 1012, 'server shutdown');\n      }\n    } else {\n      this.sendError(500, 1012, 'server shutdown');\n    }\n  }\n}\n","import http from 'http';\nimport WebSocketWrapper from './WebSocketWrapper.mjs';\n\nfunction wrapWebsocket(fn) {\n  if (typeof fn !== 'function') {\n    return fn;\n  }\n  return (req, res, next) => {\n    if (WebSocketWrapper.isInstance(res)) {\n      fn(req, res, next);\n    } else {\n      next('route');\n    }\n  };\n}\n\nexport function wrapNonWebsocket(fn) {\n  if (typeof fn !== 'function') {\n    return fn;\n  }\n  return (req, res, next) => {\n    if (WebSocketWrapper.isInstance(res)) {\n      next('route');\n    } else {\n      fn(req, res, next);\n    }\n  };\n}\n\nfunction wrapHandler(o, method, wrapper) {\n  const target = o;\n  const original = target[method].bind(target);\n  target[method] = (...handlers) => original(...handlers.map(wrapper));\n}\n\nexport default function wrapHandlers(o, src = null) {\n  const target = o;\n\n  if (src) {\n    target.use = src.use.bind(src);\n    http.METHODS.forEach((method) => {\n      const name = method.toLowerCase();\n      target[name] = src[name].bind(src);\n    });\n    target.all = src.all.bind(src);\n  }\n\n  target.ws = target.use;\n  wrapHandler(target, 'ws', wrapWebsocket);\n\n  target.useHTTP = target.use;\n  wrapHandler(target, 'useHTTP', wrapNonWebsocket);\n\n  http.METHODS.forEach((method) => {\n    wrapHandler(target, method.toLowerCase(), wrapNonWebsocket);\n  });\n\n  wrapHandler(target, 'all', wrapNonWebsocket);\n}\n","import http from 'http';\nimport express from 'express';\nimport WebSocket from 'ws';\nimport WebSocketWrapper from './WebSocketWrapper.mjs';\nimport wrapHandlers, { wrapNonWebsocket } from './wrapHandlers.mjs';\n\nconst FORWARDED_EXPRESS_METHODS = [\n  'enable',\n  'enabled',\n  'disable',\n  'disabled',\n  'set',\n  'get',\n  'engine',\n  'path',\n];\n\nconst FORWARDED_HTTP_MIDDLEWARE = ['static', 'json', 'urlencoded'];\n\nfunction addPreCloseEvent(server) {\n  if (server.close.hasPreCloseEvent) {\n    return;\n  }\n\n  const originalClose = server.close.bind(server);\n  const wrappedClose = (callback) => {\n    server.emit('pre-close', server);\n    originalClose(callback);\n  };\n  wrappedClose.hasPreCloseEvent = true;\n\n  /* eslint-disable-next-line no-param-reassign */ // close interception\n  server.close = wrappedClose;\n}\n\nfunction bindWithOriginalThis(fn, thisArg) {\n  return function wrapped(...args) {\n    return fn.call(thisArg, this, ...args);\n  };\n}\n\nexport default class WebSocketExpress {\n  constructor(...args) {\n    this.app = express(...args);\n    this.locals = this.app.locals;\n    this.wsServer = new WebSocket.Server({ noServer: true });\n    this.activeWebSockets = new WeakMap();\n\n    this.app.use((err, req, res, next) => {\n      // error handler: close web socket\n      if (WebSocketWrapper.isInstance(res)) {\n        res.sendError(500);\n      }\n      next(err);\n    });\n\n    this.handleUpgrade = bindWithOriginalThis(this.handleUpgrade, this);\n    this.handleRequest = this.handleRequest.bind(this);\n    this.handlePreClose = this.handlePreClose.bind(this);\n\n    FORWARDED_EXPRESS_METHODS.forEach((method) => {\n      this[method] = this.app[method].bind(this.app);\n    });\n\n    wrapHandlers(this, this.app);\n  }\n\n  handleUpgrade(server, req, socket, head) {\n    const wrap = new WebSocketWrapper(this.wsServer, req, socket, head);\n\n    const socketSet = this.activeWebSockets.get(server);\n    socketSet.add(wrap);\n    socket.on('close', () => socketSet.delete(wrap));\n\n    return this.app(req, wrap);\n  }\n\n  handleRequest(req, res) {\n    return this.app(req, res);\n  }\n\n  handlePreClose(server) {\n    let expiry = 0;\n    const shutdownTimeout = this.app.get('shutdown timeout');\n    if (typeof shutdownTimeout === 'number' && shutdownTimeout >= 0) {\n      expiry = Date.now() + shutdownTimeout;\n    }\n    const socketSet = this.activeWebSockets.get(server);\n    [...socketSet].forEach((s) => s.internalSoftClose(expiry));\n  }\n\n  attach(server) {\n    if (this.activeWebSockets.has(server)) {\n      throw new Error('Cannot attach to the same server multiple times');\n    }\n    this.activeWebSockets.set(server, new Set());\n    addPreCloseEvent(server);\n    server.on('upgrade', this.handleUpgrade);\n    server.on('request', this.handleRequest);\n    server.on('pre-close', this.handlePreClose);\n  }\n\n  detach(server) {\n    if (!this.activeWebSockets.has(server)) {\n      return; // not attached\n    }\n    server.removeListener('upgrade', this.handleUpgrade);\n    server.removeListener('request', this.handleRequest);\n    server.removeListener('pre-close', this.handlePreClose);\n    this.handlePreClose(server);\n    this.activeWebSockets.delete(server);\n  }\n\n  createServer() {\n    const server = http.createServer();\n    this.attach(server);\n    return server;\n  }\n\n  listen(...args) {\n    const server = this.createServer();\n    return server.listen(...args);\n  }\n}\n\nFORWARDED_HTTP_MIDDLEWARE.forEach((middleware) => {\n  WebSocketExpress[middleware] = (...args) =>\n    wrapNonWebsocket(express[middleware](...args));\n  Object.assign(WebSocketExpress[middleware], express[middleware]);\n});\n","import express from 'express';\nimport wrapHandlers from './wrapHandlers.mjs';\n\nexport default class Router extends express.Router {\n  constructor(...args) {\n    super(...args);\n    wrapHandlers(this);\n  }\n}\n","import WebSocketWrapper from './WebSocketWrapper.mjs';\n\nfunction splitFirst(data, delimiter) {\n  const sep = data.indexOf(delimiter);\n  if (sep === -1) {\n    return [data];\n  }\n  return [data.substr(0, sep), data.substr(sep + delimiter.length)];\n}\n\nasync function getProvidedToken(req, res) {\n  const auth = req.get('Authorization');\n  if (auth) {\n    const [type, data] = splitFirst(auth, ' ');\n\n    if (type === 'Bearer') {\n      return data;\n    }\n\n    return null;\n  }\n\n  if (WebSocketWrapper.isInstance(res)) {\n    const ws = await res.accept();\n    const tokenMessage = await ws.nextMessage({ timeout: 5000 });\n    if (tokenMessage.isBinary) {\n      throw new Error('Token must be sent as text');\n    }\n    return String(tokenMessage.data);\n  }\n\n  return null;\n}\n\nfunction extractScopesMap(data) {\n  if (!data || typeof data !== 'object' || !data.scopes) {\n    return {};\n  }\n  const { scopes } = data;\n  if (Array.isArray(scopes)) {\n    const result = {};\n    scopes.forEach((scope) => {\n      result[scope] = true;\n    });\n    return result;\n  }\n  if (typeof scopes === 'object') {\n    return scopes;\n  }\n  if (typeof scopes === 'string') {\n    return { [scopes]: true };\n  }\n  return {};\n}\n\nexport function requireBearerAuth(realm, extractAndValidateToken) {\n  let realmForRequest;\n  if (typeof realm === 'string') {\n    realmForRequest = () => realm;\n  } else if (typeof realm === 'function') {\n    realmForRequest = realm;\n  } else {\n    throw new Error('Invalid realm; must be a string or function');\n  }\n\n  return async (req, res, next) => {\n    const now = Math.floor(Date.now() / 1000);\n    const authRealm = await realmForRequest(req, res);\n    const token = await getProvidedToken(req, res);\n\n    let tokenData = null;\n    if (token) {\n      tokenData = await extractAndValidateToken(token, authRealm, req, res);\n    }\n\n    if (\n      !tokenData ||\n      (typeof tokenData.nbf === 'number' && now < tokenData.nbf) ||\n      (typeof tokenData.exp === 'number' && now >= tokenData.exp)\n    ) {\n      res\n        .status(401)\n        .header('WWW-Authenticate', `Bearer realm=\"${authRealm}\"`)\n        .end();\n      return;\n    }\n\n    if (typeof tokenData.exp === 'number' && WebSocketWrapper.isInstance(res)) {\n      res.closeAtTime(tokenData.exp * 1000, 1001, 'Session expired');\n    }\n\n    res.locals.authRealm = authRealm;\n    res.locals.authData = tokenData;\n    res.locals.authScopes = extractScopesMap(tokenData);\n\n    next();\n  };\n}\n\nexport function getAuthData(res) {\n  if (!res || typeof res !== 'object' || !res.locals) {\n    throw new Error('Must provide response object to getAuthData');\n  }\n  return res.locals.authData || null;\n}\n\nexport function hasAuthScope(res, scope) {\n  if (!res || typeof res !== 'object' || !res.locals) {\n    throw new Error('Must provide response object to hasAuthScope');\n  }\n  const { authScopes } = res.locals;\n  return Boolean(authScopes && authScopes[scope]);\n}\n\nexport function requireAuthScope(scope) {\n  return async (req, res, next) => {\n    const { authRealm } = res.locals;\n    if (!hasAuthScope(res, scope)) {\n      res\n        .status(403)\n        .header(\n          'WWW-Authenticate',\n          `Bearer realm=\"${authRealm}\", scope=\"${scope}\"`,\n        )\n        .end();\n      return;\n    }\n    next();\n  };\n}\n","import WebSocketExpress from './WebSocketExpress.mjs';\nimport WebSocketWrapper from './WebSocketWrapper.mjs';\nimport Router from './Router.mjs';\nimport {\n  requireBearerAuth,\n  requireAuthScope,\n  getAuthData,\n  hasAuthScope,\n} from './auth.mjs';\n\nexport const isWebSocket = WebSocketWrapper.isInstance;\n\nWebSocketExpress.Router = Router;\nWebSocketExpress.isWebSocket = isWebSocket;\nWebSocketExpress.requireBearerAuth = requireBearerAuth;\nWebSocketExpress.requireAuthScope = requireAuthScope;\nWebSocketExpress.getAuthData = getAuthData;\nWebSocketExpress.hasAuthScope = hasAuthScope;\n\nexport default WebSocketExpress;\nexport {\n  Router,\n  requireBearerAuth,\n  requireAuthScope,\n  getAuthData,\n  hasAuthScope,\n};\n"],"names":["NONCE","abortHandshake","socket","code","message","headers","writable","resolvedMessage","STATUS_CODES","resolvedHeaders","Connection","Buffer","byteLength","write","Object","keys","map","h","join","destroy","httpStatusToWs","nextMessage","ws","timeout","Promise","resolve","reject","onMessage","onClose","exp","detach","off","clearTimeout","data","isBinary","undefined","from","on","setTimeout","bindExtraMethods","bind","WebSocketWrapper","constructor","wsServer","req","head","closed","nonce","transactionNesting","closeTimeout","closeTime","closeTimeoutCode","closeTimeoutMessage","softClosing","accept","closeAtTime","sendError","setHeader","status","end","send","beginTransaction","endTransaction","internalCheckCloseTimeout","internalSoftClose","isInstance","o","Error","handleUpgrade","httpStatus","wsStatus","msg","close","now","Date","Math","min","time","then","limit","wrapWebsocket","fn","res","next","wrapNonWebsocket","wrapHandler","method","wrapper","target","original","handlers","wrapHandlers","src","use","http","METHODS","forEach","name","toLowerCase","all","useHTTP","FORWARDED_EXPRESS_METHODS","FORWARDED_HTTP_MIDDLEWARE","addPreCloseEvent","server","hasPreCloseEvent","originalClose","wrappedClose","callback","emit","bindWithOriginalThis","thisArg","wrapped","args","call","WebSocketExpress","app","express","locals","WebSocket","Server","noServer","activeWebSockets","WeakMap","err","handleRequest","handlePreClose","wrap","socketSet","get","add","delete","expiry","shutdownTimeout","s","attach","has","set","Set","removeListener","createServer","listen","middleware","assign","Router","splitFirst","delimiter","sep","indexOf","substr","length","getProvidedToken","auth","type","tokenMessage","String","extractScopesMap","scopes","Array","isArray","result","scope","requireBearerAuth","realm","extractAndValidateToken","realmForRequest","floor","authRealm","token","tokenData","nbf","header","authData","authScopes","getAuthData","hasAuthScope","Boolean","requireAuthScope","isWebSocket"],"mappings":"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"}