{"version":3,"sources":["webpack://websocket-express/webpack/universalModuleDefinition","webpack://websocket-express/webpack/bootstrap","webpack://websocket-express/external \"http\"","webpack://websocket-express/external \"express\"","webpack://websocket-express/external \"ws\"","webpack://websocket-express/./src/WebSocketWrapper.js","webpack://websocket-express/./src/wrapHandlers.js","webpack://websocket-express/./src/WebSocketExpress.js","webpack://websocket-express/./src/Router.js","webpack://websocket-express/./src/auth.js","webpack://websocket-express/./src/index.js"],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","NONCE","abortHandshake","socket","code","message","headers","writable","resolvedMessage","STATUS_CODES","resolvedHeaders","Connection","Buffer","byteLength","write","keys","map","h","join","destroy","nextMessage","ws","timeout","Promise","resolve","reject","onMessage","onClose","exp","detach","off","clearTimeout","data","isBinary","undefined","from","on","setTimeout","bindExtraMethods","WebSocketWrapper","constructor","wsServer","req","head","this","closed","nonce","transactionNesting","closeTimeout","closeTime","closeTimeoutCode","closeTimeoutMessage","softClosing","accept","closeAtTime","sendError","setHeader","status","end","send","beginTransaction","endTransaction","internalCheckCloseTimeout","internalSoftClose","Error","handleUpgrade","httpStatus","wsStatus","msg","close","now","Date","Math","min","time","then","limit","wrapWebsocket","fn","res","next","isInstance","wrapNonWebsocket","wrapHandler","method","wrapper","target","original","handlers","wrapHandlers","src","use","http","METHODS","forEach","toLowerCase","all","useHTTP","FORWARDED_EXPRESS_METHODS","WebSocketExpress","args","thisArg","app","express","locals","WebSocket","Server","noServer","activeWebSockets","WeakMap","err","handleRequest","handlePreClose","server","wrap","socketSet","add","delete","expiry","shutdownTimeout","attach","has","set","Set","hasPreCloseEvent","originalClose","wrappedClose","callback","emit","addPreCloseEvent","removeListener","createServer","listen","middleware","assign","Router","super","requireBearerAuth","realm","extractAndValidateToken","realmForRequest","async","floor","authRealm","token","auth","type","delimiter","sep","indexOf","substr","length","splitFirst","tokenMessage","String","getProvidedToken","tokenData","nbf","header","authData","authScopes","scopes","Array","isArray","result","scope","extractScopesMap","getAuthData","hasAuthScope","Boolean","requireAuthScope","isWebSocket"],"mappings":"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","file":"index.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"websocket-express\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"websocket-express\"] = factory();\n\telse\n\t\troot[\"websocket-express\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 3);\n","module.exports = require(\"http\");","module.exports = require(\"express\");","module.exports = require(\"ws\");","import { STATUS_CODES } from 'http';\n\nconst NONCE = {};\n\n// Copied from https://github.com/websockets/ws/blob/master/lib/websocket-server.js#L374\nfunction abortHandshake(socket, code, message, headers) {\n  if (socket.writable) {\n    const resolvedMessage = message || STATUS_CODES[code];\n    const resolvedHeaders = {\n      Connection: 'close',\n      'Content-type': 'text/html',\n      'Content-Length': Buffer.byteLength(resolvedMessage),\n      ...headers,\n    };\n\n    socket.write([\n      `HTTP/1.1 ${code} ${STATUS_CODES[code]}`,\n      ...Object.keys(resolvedHeaders).map((h) => `${h}: ${resolvedHeaders[h]}`),\n      '',\n      resolvedMessage,\n    ].join('\\r\\n'));\n  }\n\n  socket.destroy();\n}\n\nfunction httpStatusToWs(code) {\n  if (code >= 500) {\n    return 1011;\n  }\n  return 4000 + code;\n}\n\nfunction nextMessage(ws, { timeout = 0 } = {}) {\n  return new Promise((resolve, reject) => {\n    let onMessage = null;\n    let onClose = null;\n    let exp = null;\n\n    const detach = () => {\n      ws.off('message', onMessage);\n      ws.off('close', onClose);\n      clearTimeout(exp);\n    };\n\n    onMessage = (data, isBinary) => {\n      detach();\n      if (isBinary !== undefined) { // ws 8.x\n        resolve({ data, isBinary });\n      } else if (typeof data === 'string') { // ws 7.x\n        resolve({ data: Buffer.from(data, 'utf8'), isBinary: false });\n      } else {\n        resolve({ data, isBinary: true });\n      }\n    };\n\n    onClose = () => {\n      detach();\n      reject();\n    };\n\n    ws.on('message', onMessage);\n    ws.on('close', onClose);\n    if (timeout > 0) {\n      exp = setTimeout(onClose, timeout);\n    }\n  });\n}\n\nfunction bindExtraMethods(ws) {\n  // eslint-disable-next-line no-param-reassign\n  ws.nextMessage = nextMessage.bind(null, ws);\n}\n\nexport default class WebSocketWrapper {\n  constructor(wsServer, req, socket, head) {\n    this.wsServer = wsServer;\n    this.req = req;\n    this.socket = socket;\n    this.head = head;\n    this.ws = null;\n    this.closed = false;\n    this.nonce = NONCE;\n    this.transactionNesting = 0;\n    this.closeTimeout = null;\n    this.closeTime = 0;\n    this.closeTimeoutCode = null;\n    this.closeTimeoutMessage = null;\n    this.softClosing = false;\n\n    // expressjs builds new objects using properties of response, so all methods\n    // must be explicitly added to the instance, not just the class\n    this.accept = this.accept;\n    this.reject = this.reject;\n    this.closeAtTime = this.closeAtTime;\n    this.sendError = this.sendError;\n    this.setHeader = () => {}; // compatibility with expressjs (fake http.Response API)\n    this.status = this.status;\n    this.end = this.end;\n    this.send = this.send;\n    this.beginTransaction = this.beginTransaction;\n    this.endTransaction = this.endTransaction;\n    this.internalCheckCloseTimeout = this.internalCheckCloseTimeout;\n    this.internalSoftClose = this.internalSoftClose;\n  }\n\n  static isInstance(o) {\n    // expressjs builds new objects using properties of response, so we cannot\n    // rely on instanceof checks. Instead we use a nonce property:\n    return o && (o.nonce === NONCE);\n  }\n\n  accept() {\n    if (this.closed) {\n      return Promise.reject(new Error('Connection closed'));\n    }\n    if (this.ws) {\n      return Promise.resolve(this.ws);\n    }\n\n    return new Promise((resolve) => this.wsServer.handleUpgrade(\n      this.req,\n      this.socket,\n      this.head,\n      (ws) => {\n        bindExtraMethods(ws);\n        ws.on('close', () => clearTimeout(this.closeTimeout));\n        this.ws = ws;\n        resolve(this.ws);\n      },\n    ));\n  }\n\n  reject(code = 500, message = null) {\n    if (this.ws) {\n      throw new Error('Already accepted WebSocket connection');\n    }\n    this.sendError(code, null, message);\n  }\n\n  sendError(httpStatus, wsStatus = null, message = null) {\n    if (this.closed) {\n      throw new Error('Connection closed');\n    }\n\n    const msg = message || STATUS_CODES[httpStatus];\n\n    this.closed = true;\n    if (this.ws) {\n      this.ws.close(wsStatus || httpStatusToWs(httpStatus), msg);\n    } else {\n      abortHandshake(this.socket, httpStatus, msg);\n    }\n  }\n\n  internalCheckCloseTimeout() {\n    clearTimeout(this.closeTimeout);\n\n    if (this.closed) {\n      return;\n    }\n\n    const now = Date.now();\n    if (now < this.closeTime) {\n      this.closeTimeout = setTimeout(\n        this.internalCheckCloseTimeout.bind(this),\n        Math.min(this.closeTime - now, 1000 * 60 * 60 * 24),\n      );\n      return;\n    }\n\n    this.closed = true;\n    if (this.ws) {\n      this.ws.close(this.closeTimeoutCode, this.closeTimeoutMessage);\n    } else {\n      abortHandshake(this.socket, 200, 'Connection time limit reached');\n    }\n  }\n\n  closeAtTime(time, code = 1001, message = '') {\n    if (this.closed) {\n      return;\n    }\n    if (this.closeTimeout !== null && time >= this.closeTime) {\n      return;\n    }\n    this.closeTime = time;\n    this.closeTimeoutCode = code;\n    this.closeTimeoutMessage = message;\n    this.internalCheckCloseTimeout();\n  }\n\n  status(code) {\n    if (code < 400 && this.ws) {\n      throw new Error('Already accepted WebSocket connection');\n    }\n    this.sendError(code);\n    return this;\n  }\n\n  end() {\n    if (!this.ws && !this.closed) {\n      this.sendError(404);\n    }\n    return this;\n  }\n\n  send(message) {\n    if (!this.closed) {\n      this.accept().then((ws) => {\n        ws.send(message);\n        ws.close();\n      });\n      this.closed = true;\n    }\n    return this;\n  }\n\n  beginTransaction() {\n    this.transactionNesting += 1;\n  }\n\n  endTransaction() {\n    if (this.transactionNesting <= 0) {\n      throw new Error('Unbalanced endTransaction');\n    }\n    this.transactionNesting -= 1;\n\n    if (this.transactionNesting === 0 && this.softClosing && !this.closed) {\n      this.sendError(500, 1012, 'server shutdown');\n    }\n  }\n\n  internalSoftClose(limit) {\n    if (this.closed) {\n      return;\n    }\n\n    if (this.transactionNesting > 0) {\n      this.softClosing = true;\n      if (limit) {\n        this.closeAtTime(limit, 1012, 'server shutdown');\n      }\n    } else {\n      this.sendError(500, 1012, 'server shutdown');\n    }\n  }\n}\n","import http from 'http';\nimport WebSocketWrapper from './WebSocketWrapper';\n\nfunction wrapWebsocket(fn) {\n  if (typeof fn !== 'function') {\n    return fn;\n  }\n  return (req, res, next) => {\n    if (WebSocketWrapper.isInstance(res)) {\n      fn(req, res, next);\n    } else {\n      next('route');\n    }\n  };\n}\n\nexport function wrapNonWebsocket(fn) {\n  if (typeof fn !== 'function') {\n    return fn;\n  }\n  return (req, res, next) => {\n    if (WebSocketWrapper.isInstance(res)) {\n      next('route');\n    } else {\n      fn(req, res, next);\n    }\n  };\n}\n\nfunction wrapHandler(o, method, wrapper) {\n  const target = o;\n  const original = target[method].bind(target);\n  target[method] = (...handlers) => original(...handlers.map(wrapper));\n}\n\nexport default function wrapHandlers(o, src = null) {\n  const target = o;\n\n  if (src) {\n    target.use = src.use.bind(src);\n    http.METHODS.forEach((method) => {\n      const name = method.toLowerCase();\n      target[name] = src[name].bind(src);\n    });\n    target.all = src.all.bind(src);\n  }\n\n  target.ws = target.use;\n  wrapHandler(target, 'ws', wrapWebsocket);\n\n  target.useHTTP = target.use;\n  wrapHandler(target, 'useHTTP', wrapNonWebsocket);\n\n  http.METHODS.forEach((method) => {\n    wrapHandler(target, method.toLowerCase(), wrapNonWebsocket);\n  });\n\n  wrapHandler(target, 'all', wrapNonWebsocket);\n}\n","import http from 'http';\nimport express from 'express';\nimport WebSocket from 'ws';\nimport WebSocketWrapper from './WebSocketWrapper';\nimport wrapHandlers, { wrapNonWebsocket } from './wrapHandlers';\n\nconst FORWARDED_EXPRESS_METHODS = [\n  'enable',\n  'enabled',\n  'disable',\n  'disabled',\n  'set',\n  'get',\n  'engine',\n  'path',\n];\n\nconst FORWARDED_HTTP_MIDDLEWARE = [\n  'static',\n  'json',\n  'urlencoded',\n];\n\nfunction addPreCloseEvent(server) {\n  if (server.close.hasPreCloseEvent) {\n    return;\n  }\n\n  const originalClose = server.close.bind(server);\n  const wrappedClose = (callback) => {\n    server.emit('pre-close', server);\n    originalClose(callback);\n  };\n  wrappedClose.hasPreCloseEvent = true;\n\n  /* eslint-disable-next-line no-param-reassign */ // close interception\n  server.close = wrappedClose;\n}\n\nfunction bindWithOriginalThis(fn, thisArg) {\n  return function wrapped(...args) {\n    return fn.call(thisArg, this, ...args);\n  };\n}\n\nexport default class WebSocketExpress {\n  constructor(...args) {\n    this.app = express(...args);\n    this.locals = this.app.locals;\n    this.wsServer = new WebSocket.Server({ noServer: true });\n    this.activeWebSockets = new WeakMap();\n\n    this.app.use((err, req, res, next) => {\n      // error handler: close web socket\n      if (WebSocketWrapper.isInstance(res)) {\n        res.sendError(500);\n      }\n      next(err);\n    });\n\n    this.handleUpgrade = bindWithOriginalThis(this.handleUpgrade, this);\n    this.handleRequest = this.handleRequest.bind(this);\n    this.handlePreClose = this.handlePreClose.bind(this);\n\n    FORWARDED_EXPRESS_METHODS.forEach((method) => {\n      this[method] = this.app[method].bind(this.app);\n    });\n\n    wrapHandlers(this, this.app);\n  }\n\n  handleUpgrade(server, req, socket, head) {\n    const wrap = new WebSocketWrapper(this.wsServer, req, socket, head);\n\n    const socketSet = this.activeWebSockets.get(server);\n    socketSet.add(wrap);\n    socket.on('close', () => socketSet.delete(wrap));\n\n    return this.app(req, wrap);\n  }\n\n  handleRequest(req, res) {\n    return this.app(req, res);\n  }\n\n  handlePreClose(server) {\n    let expiry = 0;\n    const shutdownTimeout = this.app.get('shutdown timeout');\n    if (typeof shutdownTimeout === 'number' && shutdownTimeout >= 0) {\n      expiry = Date.now() + shutdownTimeout;\n    }\n    const socketSet = this.activeWebSockets.get(server);\n    [...socketSet].forEach((s) => s.internalSoftClose(expiry));\n  }\n\n  attach(server) {\n    if (this.activeWebSockets.has(server)) {\n      throw new Error('Cannot attach to the same server multiple times');\n    }\n    this.activeWebSockets.set(server, new Set());\n    addPreCloseEvent(server);\n    server.on('upgrade', this.handleUpgrade);\n    server.on('request', this.handleRequest);\n    server.on('pre-close', this.handlePreClose);\n  }\n\n  detach(server) {\n    if (!this.activeWebSockets.has(server)) {\n      return; // not attached\n    }\n    server.removeListener('upgrade', this.handleUpgrade);\n    server.removeListener('request', this.handleRequest);\n    server.removeListener('pre-close', this.handlePreClose);\n    this.handlePreClose(server);\n    this.activeWebSockets.delete(server);\n  }\n\n  createServer() {\n    const server = http.createServer();\n    this.attach(server);\n    return server;\n  }\n\n  listen(...args) {\n    const server = this.createServer();\n    return server.listen(...args);\n  }\n}\n\nFORWARDED_HTTP_MIDDLEWARE.forEach((middleware) => {\n  WebSocketExpress[middleware] = (...args) => wrapNonWebsocket(\n    express[middleware](...args),\n  );\n  Object.assign(WebSocketExpress[middleware], express[middleware]);\n});\n","import express from 'express';\nimport wrapHandlers from './wrapHandlers';\n\nexport default class Router extends express.Router {\n  constructor(...args) {\n    super(...args);\n    wrapHandlers(this);\n  }\n}\n","import WebSocketWrapper from './WebSocketWrapper';\n\nfunction splitFirst(data, delimiter) {\n  const sep = data.indexOf(delimiter);\n  if (sep === -1) {\n    return [data];\n  }\n  return [data.substr(0, sep), data.substr(sep + delimiter.length)];\n}\n\nasync function getProvidedToken(req, res) {\n  const auth = req.get('Authorization');\n  if (auth) {\n    const [type, data] = splitFirst(auth, ' ');\n\n    if (type === 'Bearer') {\n      return data;\n    }\n\n    return null;\n  }\n\n  if (WebSocketWrapper.isInstance(res)) {\n    const ws = await res.accept();\n    const tokenMessage = await ws.nextMessage({ timeout: 5000 });\n    if (tokenMessage.isBinary) {\n      throw new Error('Token must be sent as text');\n    }\n    return String(tokenMessage.data);\n  }\n\n  return null;\n}\n\nfunction extractScopesMap(data) {\n  if (!data || typeof data !== 'object' || !data.scopes) {\n    return {};\n  }\n  const { scopes } = data;\n  if (Array.isArray(scopes)) {\n    const result = {};\n    scopes.forEach((scope) => {\n      result[scope] = true;\n    });\n    return result;\n  }\n  if (typeof scopes === 'object') {\n    return scopes;\n  }\n  if (typeof scopes === 'string') {\n    return { [scopes]: true };\n  }\n  return {};\n}\n\nexport function requireBearerAuth(realm, extractAndValidateToken) {\n  let realmForRequest;\n  if (typeof realm === 'string') {\n    realmForRequest = () => realm;\n  } else if (typeof realm === 'function') {\n    realmForRequest = realm;\n  } else {\n    throw new Error('Invalid realm; must be a string or function');\n  }\n\n  return async (req, res, next) => {\n    const now = Math.floor(Date.now() / 1000);\n    const authRealm = await realmForRequest(req, res);\n    const token = await getProvidedToken(req, res);\n\n    let tokenData = null;\n    if (token) {\n      tokenData = await extractAndValidateToken(token, authRealm, req, res);\n    }\n\n    if (\n      !tokenData ||\n      (typeof tokenData.nbf === 'number' && now < tokenData.nbf) ||\n      (typeof tokenData.exp === 'number' && now >= tokenData.exp)\n    ) {\n      res\n        .status(401)\n        .header('WWW-Authenticate', `Bearer realm=\"${authRealm}\"`)\n        .end();\n      return;\n    }\n\n    if (typeof tokenData.exp === 'number' && WebSocketWrapper.isInstance(res)) {\n      res.closeAtTime(tokenData.exp * 1000, 1001, 'Session expired');\n    }\n\n    res.locals.authRealm = authRealm;\n    res.locals.authData = tokenData;\n    res.locals.authScopes = extractScopesMap(tokenData);\n\n    next();\n  };\n}\n\nexport function getAuthData(res) {\n  if (!res || typeof res !== 'object' || !res.locals) {\n    throw new Error('Must provide response object to getAuthData');\n  }\n  return res.locals.authData || null;\n}\n\nexport function hasAuthScope(res, scope) {\n  if (!res || typeof res !== 'object' || !res.locals) {\n    throw new Error('Must provide response object to hasAuthScope');\n  }\n  const { authScopes } = res.locals;\n  return Boolean(authScopes && authScopes[scope]);\n}\n\nexport function requireAuthScope(scope) {\n  return async (req, res, next) => {\n    const { authRealm } = res.locals;\n    if (!hasAuthScope(res, scope)) {\n      res\n        .status(403)\n        .header(\n          'WWW-Authenticate',\n          `Bearer realm=\"${authRealm}\", scope=\"${scope}\"`,\n        )\n        .end();\n      return;\n    }\n    next();\n  };\n}\n","import WebSocketExpress from './WebSocketExpress';\nimport WebSocketWrapper from './WebSocketWrapper';\nimport Router from './Router';\nimport {\n  requireBearerAuth,\n  requireAuthScope,\n  getAuthData,\n  hasAuthScope,\n} from './auth';\n\nexport const isWebSocket = WebSocketWrapper.isInstance;\n\nWebSocketExpress.Router = Router;\nWebSocketExpress.isWebSocket = isWebSocket;\nWebSocketExpress.requireBearerAuth = requireBearerAuth;\nWebSocketExpress.requireAuthScope = requireAuthScope;\nWebSocketExpress.getAuthData = getAuthData;\nWebSocketExpress.hasAuthScope = hasAuthScope;\n\nexport default WebSocketExpress;\nexport {\n  Router,\n  requireBearerAuth,\n  requireAuthScope,\n  getAuthData,\n  hasAuthScope,\n};\n"],"sourceRoot":""}